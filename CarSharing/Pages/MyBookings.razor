@page "/my-bookings"
@using CarSharing.BLL.DTOs.Booking
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<link href="css/MyBookings.css" rel="stylesheet" />



<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">My Bookings</h1>
        <a href="/catalog" class="btn-browse">
            🚗 Browse Cars
        </a>
    </div>

    @if (bookings == null)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading your bookings...</p>
        </div>
    }
    else if (!bookings.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">🚗</div>
            <h2 class="empty-title">No bookings yet</h2>
            <p class="empty-desc">You haven't made any bookings. Start exploring our car collection!</p>
            <a href="/catalog" class="btn-browse" style="display: inline-flex;">
                Browse Available Cars
            </a>
        </div>
    }
    else
    {
        <div class="bookings-grid">
            @foreach (var b in bookings)
            {
                var status = GetBookingStatus(b);
                var timeInfo = GetTimeInfo(b, status);

                <div class="booking-card @(status == BookingStatus.Expired ? "expired" : "")">
                    <img src="@b.CarImageUrl" alt="@b.CarTitle" class="booking-image" />

                    <div class="booking-info">
                        <h3 class="booking-title">@b.CarTitle</h3>

                        <div class="booking-dates">
                            <div class="date-item">
                                <span class="date-label">Pick-up</span>
                                <span class="date-value">@b.StartTime.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            <div class="date-item">
                                <span class="date-label">Drop-off</span>
                                <span class="date-value">@b.EndTime.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            <div class="date-item">
                                <span class="date-label">Duration</span>
                                <span class="date-value">@GetDuration(b)</span>
                            </div>
                        </div>

                        <div class="booking-status-row">
                            <span class="booking-status @GetStatusClass(status)">
                                @GetStatusText(status)
                            </span>

                            @if (!string.IsNullOrEmpty(timeInfo))
                            {
                                <span class="time-remaining @(status == BookingStatus.Active && IsUrgent(b) ? "urgent" : "")">
                                    @timeInfo
                                </span>
                            }
                        </div>
                    </div>

                    <div class="booking-actions">
                        <div class="booking-price">
                            <div class="price-value">€@b.TotalPrice.ToString("F2")</div>
                            <div class="price-label">Total paid</div>
                        </div>

                        @if (status == BookingStatus.Pending || status == BookingStatus.Active)
                        {
                            <button class="btn-cancel" @onclick="() => CancelBooking(b.Id)">
                                Cancel Booking
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<BookingDto>? bookings;

    private enum BookingStatus
    {
        Pending,
        Active,
        Expired
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBookings();
    }

    private async Task LoadBookings()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");

            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, "https://localhost:7276/api/booking/my");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                bookings = await response.Content.ReadFromJsonAsync<List<BookingDto>>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                Navigation.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bookings: {ex.Message}");
            bookings = new List<BookingDto>();
        }
    }

    private BookingStatus GetBookingStatus(BookingDto booking)
    {
        var now = DateTime.Now;

        if (now < booking.StartTime)
            return BookingStatus.Pending;
        else if (now >= booking.StartTime && now <= booking.EndTime)
            return BookingStatus.Active;
        else
            return BookingStatus.Expired;
    }

    private string GetStatusClass(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "status-pending",
            BookingStatus.Active => "status-active",
            BookingStatus.Expired => "status-expired",
            _ => ""
        };
    }

    private string GetStatusText(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "⏳ Pending",
            BookingStatus.Active => "✓ Active",
            BookingStatus.Expired => "✓ Completed",
            _ => ""
        };
    }

    private string GetTimeInfo(BookingDto booking, BookingStatus status)
    {
        var now = DateTime.Now;

        if (status == BookingStatus.Pending)
        {
            var timeUntilStart = booking.StartTime - now;
            return FormatTimeSpan(timeUntilStart, "Starts in");
        }
        else if (status == BookingStatus.Active)
        {
            var timeRemaining = booking.EndTime - now;
            return FormatTimeSpan(timeRemaining, "Time left");
        }

        return string.Empty;
    }

    private string FormatTimeSpan(TimeSpan timeSpan, string prefix)
    {
        if (timeSpan.TotalDays >= 1)
        {
            int days = (int)timeSpan.TotalDays;
            int hours = timeSpan.Hours;
            return hours > 0 ? $"{prefix}: {days}d {hours}h" : $"{prefix}: {days}d";
        }
        else if (timeSpan.TotalHours >= 1)
        {
            int hours = (int)timeSpan.TotalHours;
            int minutes = timeSpan.Minutes;
            return minutes > 0 ? $"{prefix}: {hours}h {minutes}m" : $"{prefix}: {hours}h";
        }
        else
        {
            int minutes = (int)timeSpan.TotalMinutes;
            return $"{prefix}: {minutes}m";
        }
    }

    private bool IsUrgent(BookingDto booking)
    {
        var timeRemaining = booking.EndTime - DateTime.Now;
        return timeRemaining.TotalHours <= 24;
    }

    private string GetDuration(BookingDto booking)
    {
        var duration = booking.EndTime - booking.StartTime;
        int days = (int)duration.TotalDays;
        int hours = duration.Hours;

        if (days > 0)
            return hours > 0 ? $"{days}d {hours}h" : $"{days}d";
        else
            return hours > 0 ? $"{hours}h" : $"{duration.Minutes}m";
    }

    private string GetCarImage(BookingDto booking)
    {
        return "images/car-hero.png";
    }

    private async Task CancelBooking(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to cancel this booking?");
        if (!confirmed) return;

        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");
            var request = new HttpRequestMessage(HttpMethod.Delete, $"https://localhost:7276/api/booking/{id}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                await LoadBookings();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to cancel booking. Please try again.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cancelling booking: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "An error occurred. Please try again.");
        }
    }
}