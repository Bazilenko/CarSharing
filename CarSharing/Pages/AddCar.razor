@page "/add-car"
@using CarSharing.BLL.DTOs.Car
@using System.Net.Http.Headers
@using System.IO
@using System.Globalization;    
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<link href="css/AddCar.css" rel="stylesheet" />




<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <h1>Add Your Car</h1>
            <p>List your car and start earning money</p>
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                ✓ @successMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-error">
                ✗ @errorMessage
            </div>
        }

        <EditForm Model="@carModel" OnValidSubmit="HandleSubmit">
            <div class="form-grid">
                <div class="form-group">
                    <label>Make <span class="required">*</span></label>
                    <input type="text" @bind="carModel.Make" placeholder="e.g., Toyota" required />
                </div>

                <div class="form-group">
                    <label>Model <span class="required">*</span></label>
                    <input type="text" @bind="carModel.Model" placeholder="e.g., Camry" required />
                </div>

                <div class="form-group">
                    <label>Year <span class="required">*</span></label>
                    <input type="number" @bind="carModel.Year" min="1900" max="@DateTime.Now.Year" placeholder="2020" required />

                </div>

                <div class="form-group">
                    <label>Price Per Day (€) <span class="required">*</span></label>
                
                    <input type="number" @bind="carModel.PricePerDay" @bind:event="oninput" step="0.01" min="0" placeholder="50.00" required />
                    @if (carModel.PricePerDay > 0)
                    {
                        <div class="commission-hint" style="margin-top: 8px; font-size: 0.85em; color: #666;">
                            <span>💰 Ви отримаєте: <strong>@PriceAfterCommission.ToString("F2") €</strong></span>
                            <span style="display: block; font-size: 0.9em; color: #999;">(Комісія сервісу 10%)</span>
                        </div>
                    }
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>License Plate <span class="required">*</span></label>
                    <input type="text" @bind="carModel.LicensePlate" placeholder="AB 1234 CD" required />
                </div>

                <div class="form-group">
                    <label>VIN Code</label>
                    <input type="text" @bind="carModel.VinCode" placeholder="17 characters" maxlength="17" />
                </div>

                <div class="form-group">
                    <label>Transmission <span class="required">*</span></label>
                    <select @bind="carModel.Transmission" required>
                        <option value="">Select transmission</option>
                        <option value="Automatic">Automatic</option>
                        <option value="Manual">Manual</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Fuel Type <span class="required">*</span></label>
                    <select @bind="carModel.FuelType" required>
                        <option value="">Select fuel type</option>
                        <option value="Petrol">Petrol</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Electric">Electric</option>
                        <option value="Hybrid">Hybrid</option>
                        <option value="LPG">LPG</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Body Type <span class="required">*</span></label>
                    <select @bind="carModel.BodyType" required>
                        <option value="">Select body type</option>
                        <option value="Sedan">Sedan</option>
                        <option value="SUV">SUV</option>
                        <option value="Hatchback">Hatchback</option>
                        <option value="Coupe">Coupe</option>
                        <option value="Wagon">Wagon</option>
                        <option value="Van">Van</option>
                        <option value="Pickup">Pickup</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Pet Friendly</label>
                    <div class="checkbox-group">
                        <input type="checkbox" @bind="carModel.IsPetFriendly" id="petFriendly" />
                        <label for="petFriendly" style="margin: 0;">Allow pets in the car</label>
                    </div>
                </div>
            </div>

            <div class="form-group full-width">
                <label>Location <span class="required">*</span></label>
                <div class="location-group">
                    <div class="location-input">
                        <input type="text" @bind="carModel.AddressText" placeholder="Enter address or use current location" required />
                        @if (!string.IsNullOrEmpty(locationStatus))
                        {
                            <div class="location-status @(locationError ? "error" : "success")">
                                @locationStatus
                            </div>
                        }
                    </div>
                    <button type="button" class="btn-location" @onclick="GetCurrentLocation" disabled="@isGettingLocation">
                        @if (isGettingLocation)
                        {
                            <span>⏳ Getting...</span>
                        }
                        else
                        {
                            <span>📍 Use My Location</span>
                        }
                    </button>
                </div>
            </div>

            <div class="form-group full-width image-upload-section">
                <label>Car Photos <span class="required">*</span></label>
                <div class="image-upload-area">
                    <InputFile OnChange="HandleImageUpload" multiple accept="image/*" class="file-input-hidden" id="imageUpload" />
                    <label for="imageUpload" style="cursor: pointer; display: block; width: 100%;">
                        <div class="upload-icon">📷</div>
                        <div class="upload-text">Click to upload photos</div>
                        <div class="upload-hint">PNG, JPG, JPEG up to 10MB each (max 5 photos)</div>
                    </label>
                </div>

                @if (imagePreviewUrls.Any())
                {
                    <div class="image-preview-grid">
                        @for (int i = 0; i < imagePreviewUrls.Count; i++)
                        {
                            var index = i;
                            <div class="image-preview-item">
                                <img src="@imagePreviewUrls[index]" alt="Car photo @(index + 1)" />
                                <button type="button" class="image-remove-btn" @onclick="() => RemoveImage(index)" @onclick:stopPropagation="true">×</button>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" @onclick="Cancel">Cancel</button>
                <button type="submit" class="btn-submit" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span>⏳ Adding Car...</span>
                    }
                    else
                    {
                        <span>Add Car</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private decimal PriceAfterCommission => carModel.PricePerDay * 0.9m;
    protected override async Task OnInitializedAsync()
    {
        
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");

        if (string.IsNullOrEmpty(token))
        {
            
            Navigation.NavigateTo("/login");
        }
    }

    public class PendingFile
    {
        public byte[] Data { get; set; }
        public string FileName { get; set; }
        public string ContentType { get; set; }
    }
    private CreateCarDto carModel = new CreateCarDto
    {
        Year = DateTime.Now.Year,
        IsPetFriendly = false
    };

    private List<PendingFile> filesToUpload = new();
    private List<string> imagePreviewUrls = new();

    private bool isSubmitting = false;
    private bool isGettingLocation = false;
    private string? successMessage;
    private string? errorMessage;
    private string? locationStatus;
    private bool locationError = false;

    private async Task GetCurrentLocation()
    {
        isGettingLocation = true;
        locationError = false;
        locationStatus = "Getting your location...";
        StateHasChanged();

        try
        {
            var location = await JSRuntime.InvokeAsync<GeolocationResult>("getCurrentPosition");

            if (location != null)
            {
                carModel.LocationLat = location.Latitude;
                carModel.LocationLng = location.Longitude;

                
                carModel.AddressText = $"Lat: {location.Latitude:F6}, Lng: {location.Longitude:F6}";
                locationStatus = "✓ Location detected successfully!";
                locationError = false;
            }
        }
        catch (Exception ex)
        {
            locationStatus = "✗ Could not get location. Please enter address manually.";
            locationError = true;
            Console.WriteLine($"Geolocation error: {ex.Message}");
        }
        finally
        {
            isGettingLocation = false;
            StateHasChanged();
        }
    }


    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        errorMessage = null;
        try
        {
            var files = e.GetMultipleFiles(5);
            foreach (var file in files)
            {
                if (filesToUpload.Count >= 5) { errorMessage = "Maximum 5 photos allowed"; break; }
                if (file.Size > 10 * 1024 * 1024) { errorMessage = $"File {file.Name} is too large"; continue; }

               
                var resizedFile = await file.RequestImageFileAsync(file.ContentType, 800, 800);
                using var stream = resizedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var buffer = ms.ToArray();

                
                filesToUpload.Add(new PendingFile
                {
                    Data = buffer,
                    FileName = file.Name,
                    ContentType = file.ContentType
                });

                
                var imageUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
                imagePreviewUrls.Add(imageUrl);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading: {ex.Message}";
        }
        StateHasChanged();
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < filesToUpload.Count)
        {
            filesToUpload.RemoveAt(index);
            imagePreviewUrls.RemoveAt(index);
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
           
            if (filesToUpload.Count == 0)
            {
                errorMessage = "Please add at least one photo of your car";
                isSubmitting = false;
                return;
            }

           
            using var content = new MultipartFormDataContent();

            
            content.Add(new StringContent(carModel.Make ?? ""), nameof(carModel.Make));
            content.Add(new StringContent(carModel.Model ?? ""), nameof(carModel.Model));
            content.Add(new StringContent(carModel.Year.ToString()), nameof(carModel.Year));
            content.Add(new StringContent(carModel.LicensePlate ?? ""), nameof(carModel.LicensePlate));
            content.Add(new StringContent(carModel.VinCode ?? string.Empty), nameof(carModel.VinCode));
            content.Add(new StringContent(carModel.Transmission ?? ""), nameof(carModel.Transmission));
            content.Add(new StringContent(carModel.FuelType ?? ""), nameof(carModel.FuelType));
            content.Add(new StringContent(carModel.BodyType ?? ""), nameof(carModel.BodyType));
            content.Add(new StringContent(carModel.AddressText ?? ""), nameof(carModel.AddressText));
            content.Add(new StringContent(carModel.IsPetFriendly.ToString().ToLower()), nameof(carModel.IsPetFriendly));

            
            var culture = new System.Globalization.CultureInfo("uk-UA");
            content.Add(new StringContent(carModel.PricePerDay.ToString("F2", culture)), "PricePerDay");
            content.Add(new StringContent(carModel.LocationLat.ToString("F8", culture)), "LocationLat");
            content.Add(new StringContent(carModel.LocationLng.ToString("F8", culture)), "LocationLng");
            
            foreach (var file in filesToUpload)
            {
                var fileContent = new ByteArrayContent(file.Data);
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
              
                content.Add(fileContent, "images", file.FileName);
            }

            
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");

            
            using var request = new HttpRequestMessage(HttpMethod.Post, "api/cars");
            request.Content = content;

            if (!string.IsNullOrEmpty(token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            
            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                successMessage = "✓ Car added successfully!";
                StateHasChanged();
                await Task.Delay(2000);
                Navigation.NavigateTo("/catalog");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                errorMessage = "Session is over. Please, log in again.";
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
               
                var errorBody = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error: {response.StatusCode} - {errorBody}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Submit error: {ex.Message}";
            Console.WriteLine($"Error during submission: {ex}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/catalog");
    }

    public class GeolocationResult
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}

<script>
    window.getCurrentPosition = () => {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation is not supported'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                },
                (error) => {
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    };
</script>