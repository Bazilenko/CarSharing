@page "/cars/{Id:int}"
@using CarSharing.BLL.DTOs.Car
@using CarSharing.BLL.DTOs.Booking
@using System.Net.Http.Headers
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<link href="css/CarDetails.css" rel="stylesheet" />


<div class="progress-bar">
    <div class="progress-step @(currentStep >= 1 ? "active" : "") @(currentStep > 1 ? "completed" : "")">
        <span class="step-number">1</span>
        <span>Car Details</span>
    </div>
    <div class="progress-step @(currentStep >= 2 ? "active" : "") @(currentStep > 2 ? "completed" : "")">
        <span class="step-number">2</span>
        <span>Driver Details</span>
    </div>
    <div class="progress-step @(currentStep >= 3 ? "active" : "") @(currentStep > 3 ? "completed" : "")">
        <span class="step-number">3</span>
        <span>Confirmation</span>
    </div>
</div>

@if (car == null)
{
    <div class="loading">
        <div class="spinner"></div>
        <p>Loading car details...</p>
    </div>
}
else
{
    <div class="booking-container">
        <div class="booking-main">
            @if (currentStep == 1)
            {
                <h2 class="section-title">Step 1. Car Details</h2>

                <div class="selection-card">
                    <div class="image-gallery">
                        <div class="gallery-main">
                            <img src="@GetImageSrc(currentImageIndex)" alt="@car.Model" class="gallery-image" />

                            @if (car.ImageUrls != null && car.ImageUrls.Count > 1)
                            {
                                <div class="gallery-nav">
                                    <button class="gallery-btn" @onclick="PreviousImage" disabled="@(currentImageIndex == 0)">
                                        ‹
                                    </button>
                                    <button class="gallery-btn" @onclick="NextImage" disabled="@(currentImageIndex == car.ImageUrls.Count - 1)">
                                        ›
                                    </button>
                                </div>

                                <div class="gallery-counter">
                                    @(currentImageIndex + 1) / @car.ImageUrls.Count
                                </div>
                            }
                        </div>

                        @if (car.ImageUrls != null && car.ImageUrls.Count > 1)
                        {
                            <div class="gallery-thumbnails">
                                @for (int i = 0; i < car.ImageUrls.Count; i++)
                                {
                                    var index = i;
                                    <img src="@GetImageSrc(index)"
                                         alt="Thumbnail @(index + 1)"
                                         class="thumbnail @(currentImageIndex == index ? "active" : "")"
                                         @onclick="() => currentImageIndex = index" />
                                }
                            </div>
                        }
                    </div>
                </div>

                <div class="selection-card">
                    <div class="car-info-header">
                        <div class="car-title-section">
                            <div class="car-brand">@car.Make</div>
                            <h3 class="car-title">@car.Model (@car.Year)</h3>
                            <div class="car-location">📍 @car.AddressText</div>
                        </div>
                        <button class="btn-change" @onclick="GoToCatalog">Change Car</button>
                    </div>

                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #666;">Specifications</h4>
                    <div class="specs-grid">
                        <div class="spec-item">
                            <div class="spec-icon">⚙️</div>
                            <div class="spec-content">
                                <div class="spec-label">Transmission</div>
                                <div class="spec-value">@car.Transmission</div>
                            </div>
                        </div>

                        <div class="spec-item">
                            <div class="spec-icon">⛽</div>
                            <div class="spec-content">
                                <div class="spec-label">Fuel Type</div>
                                <div class="spec-value">@car.FuelType</div>
                            </div>
                        </div>

                        <div class="spec-item">
                            <div class="spec-icon">🚗</div>
                            <div class="spec-content">
                                <div class="spec-label">Body Type</div>
                                <div class="spec-value">@car.BodyType</div>
                            </div>
                        </div>

                        <div class="spec-item">
                            <div class="spec-icon">@(car.IsPetFriendly ? "🐾" : "🚫")</div>
                            <div class="spec-content">
                                <div class="spec-label">Pet Friendly</div>
                                <div class="spec-value">@(car.IsPetFriendly ? "Yes" : "No")</div>
                            </div>
                        </div>

                        <div class="spec-item">
                            <div class="spec-icon">📊</div>
                            <div class="spec-content">
                                <div class="spec-label">Status</div>
                                <div class="spec-value">@car.Status</div>
                            </div>
                        </div>

                        <div class="spec-item">
                            <div class="spec-icon">💰</div>
                            <div class="spec-content">
                                <div class="spec-label">Price per Day</div>
                                <div class="spec-value">$@car.PricePerDay</div>
                            </div>
                        </div>
                    </div>

                    @if (car.Host != null)
                    {
                        <div class="host-section">
                            <div class="host-header">Hosted By</div>
                            <div class="host-info">
                                <div class="host-avatar">
                                    @car.Host.FirstName?.Substring(0, 1).ToUpper()
                                </div>
                                <div class="host-details">
                                    <div class="host-name">@car.Host.FirstName @car.Host.LastName</div>
                                    <div class="host-email">@car.Host.Email</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="selection-card">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">Rental Period</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" @bind="bookingDto.StartTime" min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" @bind="bookingDto.EndTime" min="@bookingDto.StartTime.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>
                </div>
            }
            else if (currentStep == 2)
            {
                <h2 class="section-title">Step 2. Driver Details</h2>

                <div class="selection-card">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-input" @bind="driverFirstName" placeholder="Enter first name" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-input" @bind="driverLastName" placeholder="Enter last name" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-input" @bind="driverEmail" placeholder="email@example.com" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-input" @bind="driverPhone" placeholder="+380 XX XXX XXXX" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label class="form-label">Driver's License Number *</label>
                            <input type="text" class="form-input" @bind="driverLicense" placeholder="Enter license number" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label class="form-label">Special Requests (Optional)</label>
                            <textarea class="form-input" rows="3" @bind="specialRequests" placeholder="Any special requests or notes..."></textarea>
                        </div>
                    </div>
                </div>
            }
            else if (currentStep == 3)
            {
                <div class="confirmation-card">
                    <div class="confirmation-icon">✓</div>
                    <h2 class="confirmation-title">Booking Confirmed!</h2>
                    <p class="confirmation-desc">Your booking has been successfully confirmed. Check your email for details.</p>
                </div>

                <div class="selection-card">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">Booking Details</h3>
                    <div style="display: flex; gap: 20px; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #E0E0E0;">
                        <img src="@GetImageSrc(0)" alt="@car.Model" style="width: 200px; height: 120px; object-fit: contain; background: #F5F8FB; border-radius: 8px; padding: 10px;" />
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #999; text-transform: uppercase;">@car.Make</div>
                            <div style="font-size: 20px; font-weight: 600; color: #1A1A1A; margin: 4px 0 12px;">@car.Model (@car.Year)</div>
                            <div style="font-size: 13px; color: #666; display: flex; align-items: center; gap: 4px;">
                                📅 @bookingDto.StartTime.ToShortDateString() - @bookingDto.EndTime.ToShortDateString()
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn-continue" @onclick="GoToMyBookings">
                    View My Bookings
                </button>
            }
        </div>

        <div class="booking-sidebar">
            <div class="price-card">
                <div class="price-header">
                    <span class="price-title">Total</span>
                    <span class="price-total">$ @CalculateTotal().ToString("F2")</span>
                </div>

                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">@car.Model × @GetDays() days</span>
                        <span class="price-value">$ @(car.PricePerDay* GetDays())</span>
                    </div>
                </div>

                @if (currentStep < 3)
                {
                    <div class="discount-input">
                        <input type="text" placeholder="Discount Code" @bind="discountCode" />
                        <button class="btn-apply">Apply</button>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-error">@errorMessage</div>
                    }

                    @if (currentStep == 1)
                    {
                        <button class="btn-continue" @onclick="GoToStep2">
                            Continue to Driver Details
                        </button>
                    }
                    else if (currentStep == 2)
                    {
                        <button class="btn-continue" @onclick="HandleBooking" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span>Processing...</span>
                            }
                            else
                            {
                                <span>Confirm Booking</span>
                            }
                        </button>
                        <button style="width: 100%; margin-top: 12px; padding: 14px; background: none; border: 1px solid #E0E0E0; border-radius: 10px; cursor: pointer;" @onclick="() => currentStep = 1">
                            ← Back to Car Details
                        </button>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private CarDto? car;
    private CreateBookingDto bookingDto = new() { StartTime = DateTime.Now.AddDays(1), EndTime = DateTime.Now.AddDays(4) };
    private string errorMessage = "";
    private bool isSubmitting = false;
    private int currentStep = 1;
    private int currentImageIndex = 0;

    // Driver Details
    private string driverFirstName = "";
    private string driverLastName = "";
    private string driverEmail = "";
    private string driverPhone = "";
    private string driverLicense = "";
    private string specialRequests = "";
    private string discountCode = "";

    private const string ApiBaseUrl = "https://localhost:7276";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            car = await Http.GetFromJsonAsync<CarDto>($"{ApiBaseUrl}/api/cars/{Id}");
            bookingDto.CarId = Id;
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load car details.";
            Console.WriteLine(ex.Message);
        }
    }

    private void NextImage()
    {
        if (car?.ImageUrls != null && currentImageIndex < car.ImageUrls.Count - 1)
        {
            currentImageIndex++;
        }
    }

    private void PreviousImage()
    {
        if (currentImageIndex > 0)
        {
            currentImageIndex--;
        }
    }

    private int GetDays()
    {
        var days = (bookingDto.EndTime - bookingDto.StartTime).Days;
        return days > 0 ? days : 1;
    }

    private decimal CalculateTotal()
    {
        if (car == null) return 0;

        var days = GetDays();
        var total = car.PricePerDay * days;

        return total;
    }

    private void GoToStep2()
    {
        if (bookingDto.EndTime <= bookingDto.StartTime)
        {
            errorMessage = "End date must be after start date.";
            return;
        }
        errorMessage = "";
        currentStep = 2;
    }

    private async Task HandleBooking()
    {
        if (string.IsNullOrEmpty(driverFirstName) || string.IsNullOrEmpty(driverLastName) ||
            string.IsNullOrEmpty(driverEmail) || string.IsNullOrEmpty(driverPhone) ||
            string.IsNullOrEmpty(driverLicense))
        {
            errorMessage = "Please fill in all required fields.";
            return;
        }

        isSubmitting = true;
        errorMessage = "";

        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "authToken");

            if (string.IsNullOrEmpty(token))
            {
                errorMessage = "Please sign in to book a car.";
                Navigation.NavigateTo("/login");
                return;
            }

            using var request = new HttpRequestMessage(HttpMethod.Post, $"{ApiBaseUrl}/api/Booking");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
            request.Content = JsonContent.Create(bookingDto);

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                currentStep = 3;
            }
            else
            {
                errorMessage = await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Connection error. Please try again.";
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private string GetImageSrc(int index)
    {
        if (car?.ImageUrls != null && index < car.ImageUrls.Count)
        {
            var img = car.ImageUrls[index];
            return img.StartsWith("http") ? img : $"{ApiBaseUrl}{img}";
        }
        return "https://via.placeholder.com/400x300?text=No+Image";
    }

    private void GoToCatalog()
    {
        Navigation.NavigateTo("/catalog");
    }

    private void GoToMyBookings()
    {
        Navigation.NavigateTo("/my-bookings");
    }
}