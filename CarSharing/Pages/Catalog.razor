@page "/catalog"
@using CarSharing.BLL.DTOs.Car
@inject HttpClient Http
@inject NavigationManager Navigation



<div class="container">
    <aside class="sidebar">
        <div class="map-section">
            <div class="map-placeholder">🗺️</div>
            <button class="show-map-btn">Show On Map</button>
        </div>

        <div class="filter-section">
            <div class="filter-title">Car Type</div>
            <div class="filter-options">
                @foreach (var type in new[] { "Mini", "Economy", "SUV", "Luxury" })
                {
                    <button class="filter-btn @(selectedCarType == type ? "active" : "")"
                            @onclick="@(() => SelectCarType(type))">
                        @type
                    </button>
                }
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-title">Transmission</div>
            <div class="checkbox-list">
                <label>
                    <input type="checkbox" @bind="filterAutomatic" />
                    <span>Automatic</span>
                </label>
                <label>
                    <input type="checkbox" @bind="filterManual" />
                    <span>Manual</span>
                </label>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-title">Price Range</div>
            <div class="price-range">
                <input type="number" class="price-input" placeholder="Min €" @bind="minPrice" @bind:event="oninput" />
                <span>—</span>
                <input type="number" class="price-input" placeholder="Max €" @bind="maxPrice" @bind:event="oninput" />
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-title">Brand</div>
            <div class="brand-pills">
                <span class="brand-pill @(selectedBrand == "" ? "active" : "")"
                      @onclick="@(() => SetBrand(""))">All</span>
                @foreach (var brand in availableBrands)
                {
                    <span class="brand-pill @(selectedBrand == brand ? "active" : "")"
                          @onclick="@(() => SetBrand(brand))">
                        @brand
                    </span>
                }
            </div>
        </div>

        <div class="filter-section">
            <button class="btn-clear-filters" style="width: 100%;" @onclick="ClearFilters">
                Clear All Filters
            </button>
        </div>
    </aside>

    <main class="main-content">
        <div class="search-bar">
            <div class="search-field">
                <label>Location</label>
                <input type="text" @bind="searchLocation" placeholder="Enter location" />
            </div>
            <div class="search-field">
                <label>Pick-up Date</label>
                <input type="date" @bind="pickupDate" />
            </div>
            <div class="search-field">
                <label>Drop-off Date</label>
                <input type="date" @bind="dropoffDate" />
            </div>
            <button class="search-submit-btn" @onclick="ApplySearch">🔍</button>
        </div>

        <div class="results-header">
            <span class="results-count">
                @if (isLoading)
                {
                    <span>Loading...</span>
                }
                else
                {
                    <span>@FilteredCars.Count() car@(FilteredCars.Count() != 1 ? "s" : "") found</span>
                }
            </span>
            <select class="sort-dropdown" @onchange="OnSortChange">
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
                <option value="year-desc">Year: Newest First</option>
                <option value="year-asc">Year: Oldest First</option>
            </select>
        </div>

        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading available cars...</p>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="empty-state">
                <div class="empty-state-icon">⚠️</div>
                <div class="empty-state-title">Error Loading Cars</div>
                <div class="empty-state-text">@errorMessage</div>
                <button class="view-deal-btn" @onclick="LoadCars">Try Again</button>
            </div>
        }
        else if (!FilteredCars.Any())
        {
            <div class="empty-state">
                <div class="empty-state-icon">🚗</div>
                <div class="empty-state-title">No Cars Found</div>
                <div class="empty-state-text">Try adjusting your filters to see more results.</div>
                <button class="btn-clear-filters" @onclick="ClearFilters">Clear Filters</button>
            </div>
        }
        else
        {
            <div class="car-grid">
                @foreach (var car in FilteredCars)
                {
                    <div class="car-card" @onclick="() => GoToDetails(car.Id)">
                        <div class="car-header">
                            <div>
                                <div class="car-brand">@car.Make</div>
                                <div class="car-title">@car.Model</div>
                                <div class="car-subtitle">@car.Year · @car.Transmission</div>
                            </div>
                            <div class="rental-conditions">ℹ️ Details</div>
                        </div>

                        <img src="@GetCarImage(car)"
                             alt="@car.Model"
                             class="car-image"
                             onerror="this.src='images/no-car.png'" />

                        <div class="car-specs">
                            <span class="spec-item">⚙️ @car.Transmission</span>
                            <span class="spec-item">📅 @car.Year</span>
                            @if (car.IsPetFriendly)
                            {
                                <span class="spec-item">🐾 Pet Friendly</span>
                            }
                            @if (!string.IsNullOrEmpty(car.AddressText))
                            {
                                <span class="spec-item">📍 @car.AddressText</span>
                            }
                        </div>

                        <div class="price-section">
                            <div class="price-info">
                                <div class="current-price">@car.PricePerDay.ToString("F0") €</div>
                                <div class="price-per-day">Price per day</div>
                            </div>
                            <button class="view-deal-btn" @onclick:stopPropagation="true" @onclick="() => GoToDetails(car.Id)">
                                View Deal
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </main>
</div>

@code {
    private List<CarDto>? Cars;
    private string searchLocation = "";
    private DateTime pickupDate = DateTime.Now;
    private DateTime dropoffDate = DateTime.Now.AddDays(3);

    private string selectedCarType = "";
    private string selectedBrand = "";
    private bool filterAutomatic = false;
    private bool filterManual = false;
    private decimal? minPrice;
    private decimal? maxPrice;
    private string sortBy = "price-asc";

    private bool isLoading = true;
    private string? errorMessage = null;
    private List<string> availableBrands = new();

    private IEnumerable<CarDto> FilteredCars
    {
        get
        {
            if (Cars == null) return Enumerable.Empty<CarDto>();

            var filtered = Cars.AsEnumerable();

            if (!string.IsNullOrEmpty(selectedBrand))
                filtered = filtered.Where(c => c.Make.Equals(selectedBrand, StringComparison.OrdinalIgnoreCase));

            if (minPrice.HasValue)
                filtered = filtered.Where(c => c.PricePerDay >= minPrice.Value);

            if (maxPrice.HasValue)
                filtered = filtered.Where(c => c.PricePerDay <= maxPrice.Value);

            if (filterAutomatic || filterManual)
            {
                filtered = filtered.Where(c =>
                    (filterAutomatic && c.Transmission.Equals("Automatic", StringComparison.OrdinalIgnoreCase)) ||
                    (filterManual && c.Transmission.Equals("Manual", StringComparison.OrdinalIgnoreCase)));
            }

            return sortBy switch
            {
                "price-desc" => filtered.OrderByDescending(c => c.PricePerDay),
                "year-asc" => filtered.OrderBy(c => c.Year),
                "year-desc" => filtered.OrderByDescending(c => c.Year),
                _ => filtered.OrderBy(c => c.PricePerDay)
            };
        }
    }

    protected override async Task OnInitializedAsync() => await LoadCars();

    private async Task LoadCars()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            Cars = await Http.GetFromJsonAsync<List<CarDto>>("api/cars");
            if (Cars != null)
            {
                availableBrands = Cars.Select(c => c.Make).Distinct().OrderBy(b => b).ToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load cars. Please try again later.";
            Cars = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectCarType(string type) => selectedCarType = selectedCarType == type ? "" : type;
    private void SetBrand(string brand) => selectedBrand = brand;
    private void ClearFilters()
    {
        selectedCarType = selectedBrand = searchLocation = "";
        filterAutomatic = filterManual = false;
        minPrice = maxPrice = null;
    }

    private void OnSortChange(ChangeEventArgs e) => sortBy = e.Value?.ToString() ?? "price-asc";
    private void GoToDetails(int id) => Navigation.NavigateTo($"/car/{id}");

    private string GetCarImage(CarDto car) => car.ImageUrls?.FirstOrDefault() ?? "images/no-car.png";
    private void ApplySearch() {  }
}